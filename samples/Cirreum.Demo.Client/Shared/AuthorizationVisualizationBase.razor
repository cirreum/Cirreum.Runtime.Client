@using System.Collections.Immutable
@using System.Text
@using Cirreum.Authorization
@using Cirreum.Authorization.Analysis
@using Cirreum.Authorization.Documentation
@using Cirreum.Authorization.Documentation.Formatters
@using Cirreum.Authorization.Modeling.Export
@using Cirreum.Demo.Client.Services
@inject IAuthorizationDataService AuthorizationDataService
@inject IAuthorizationRoleRegistry RoleRegistry
@inject IMermaidService MermaidService
@inject IWasmFileSystem FileSystem
@inject IServiceProvider ServiceProvider
@inject IAuthorizationDocumenter StaticDocumenter

@*
	Shared Authorization Visualization Base Component
	Can be used on any page that needs to display authorization analysis results.
	Works with both ClientAuthorizationDataService (WASM realtime) and ApiAuthorizationDataService (server API).
*@

<div class="authorization-visualization">
	<div class="my-3 mx-2 d-flex justify-content-between align-items-center">
		<div class="btn-group" role="group">
			<button class="btn btn-sm btn-outline-primary" @onclick="RefreshAnalysis" disabled="@IsLoading">
				<i class="fas fa-refresh @(IsLoading ? "fa-spin" : "")"></i> Refresh
			</button>
			<button class="btn btn-sm btn-outline-secondary" @onclick="ToggleTheme">
				<i class="fas fa-palette"></i> @(CurrentTheme == "dark" ? "Light" : "Dark") Theme
			</button>
		</div>

		@if (ShowExportButtons) {
			<div class="btn-group" role="group">
				<button class="btn btn-sm btn-outline-info" @onclick="ExportMarkdown" disabled="@(AnalysisReport == null)">
					<i class="fas fa-file-alt"></i> Export MD
				</button>
				<button class="btn btn-sm btn-outline-info" @onclick="ExportHtml" disabled="@(AnalysisReport == null)">
					<i class="fas fa-file-code"></i> Export HTML
				</button>
				<button class="btn btn-sm btn-outline-info" @onclick="ExportCsv" disabled="@(AnalysisReport == null)">
					<i class="fas fa-file-csv"></i> Export CSV
				</button>
			</div>
		}
	</div>

	@if (ShowAnalysisOptions) {
		<div class="analysis-options mb-3 p-3 bg-light rounded">
			<div class="row align-items-center">
				<div class="col-md-3">
					<label class="form-label">Max Hierarchy Depth</label>
					<input type="number" class="form-control form-control-sm" @bind="MaxHierarchyDepth" min="1" max="20" />
				</div>
				<div class="col-md-3">
					<div class="form-check">
						<input class="form-check-input" type="checkbox" @bind="IncludeInfoIssues" id="includeInfo">
						<label class="form-check-label" for="includeInfo">
							Include Info Issues
						</label>
					</div>
				</div>
				<div class="col-md-2">
					<button class="btn btn-sm btn-primary w-100" @onclick="ApplyOptionsAndReanalyze" disabled="@IsLoading">
						<i class="fas fa-play"></i> Apply & Run
					</button>
				</div>
				<div class="col-md-4">
					@if (AnalysisSummary != null) {
						<div class="alert @(AnalysisSummary.Passed ? "alert-success" : "alert-danger") mb-0 p-2">
							<strong>Status:</strong> @(AnalysisSummary.Passed ? "PASSED" : "FAILED")
							| <strong>Issues:</strong> @AnalysisSummary.TotalIssues
							(@AnalysisSummary.ErrorCount errors, @AnalysisSummary.WarningCount warnings, @AnalysisSummary.InfoCount info)
						</div>
					}
				</div>
			</div>
		</div>
	}

	<ContentLoader IsLoading="@IsLoading">
		<LoadingTemplate>
			<div class="alert alert-info">
				<i class="fas fa-spinner fa-spin me-2"></i>@LoadingMessage
			</div>
		</LoadingTemplate>
		<ContentTemplate>
			<Tabs>
				<Tab Name="Summary">
					<div class="container-fluid">
						@if (AnalysisSummary != null) {
							<AuthorizationSummaryCards Summary="@AnalysisSummary"
													   TotalRoles="@TotalRoles"
													   ResourceCatalog="@ResourceCatalog" />

							<div class="row mb-4">
								<div class="col-md-12">
									<div class="alert @(AnalysisSummary.Passed ? "alert-success" : "alert-danger") d-flex align-items-center">
										<i class="bi @(AnalysisSummary.Passed ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill") me-2 fs-4"></i>
										<div>
											<h5 class="alert-heading mb-1">@(AnalysisSummary.Passed ? "Analysis Passed" : "Issues Found")</h5>
											<p class="mb-0">
												@if (AnalysisSummary.Passed) {
													<span>Your authorization system appears to be properly configured.</span>
												} else {
													<span>Found @AnalysisSummary.TotalIssues issues (@AnalysisSummary.ErrorCount errors, @AnalysisSummary.WarningCount warnings, @AnalysisSummary.InfoCount info).</span>
												}
											</p>
										</div>
									</div>
								</div>
							</div>
						}

						<div class="row">
							<div class="col-md-6">
								<h4>Metrics by Category</h4>
								@if (MetricsByCategory != null) {
									@foreach (var category in MetricsByCategory) {
										<div class="metric-category mb-3">
											<h6 class="text-primary">@category.Key</h6>
											<ul class="list-group list-group-flush">
												@foreach (var metric in category) {
													var metricName = MetricCategories.GetMetricName(metric.Key);
													<li class="list-group-item d-flex justify-content-between align-items-center">
														@metricName
														<span class="badge text-bg-primary rounded-pill">@metric.Value</span>
													</li>
												}
											</ul>
										</div>
									}
								}
							</div>
							<div class="col-md-6">
								<h4>Authorization Flow</h4>
								<MermaidDiagram DiagramDefinition="@AuthFlowDiagram" Theme="@CurrentTheme" />
							</div>
						</div>
					</div>
				</Tab>

				<Tab Name="Domain">
					<DomainModelView ResourceCatalog="@ResourceCatalog" />
				</Tab>

				<Tab Name="Roles">
					<div class="container-fluid">
						<div class="row">
							<div class="col-md-6">
								<h4>Role Hierarchy Visualization</h4>
								<MermaidDiagram DiagramDefinition="@RoleHierarchyDiagram" Theme="@CurrentTheme" />
							</div>
							<div class="col-md-6">
								<h4>Role Details</h4>
								<div class="mb-3">
									<input type="text" class="form-control" placeholder="Filter roles..."
									       @bind="RoleFilter" @bind:event="oninput" />
								</div>

								@{
									var filteredRoles = GetFilteredRoles();
								}

								<div class="role-list" style="max-height: 600px; overflow-y: auto;">
									@foreach (var roleInfo in filteredRoles) {
										var role = roleInfo.Role;
										var borderClass = role.IsApplicationRole ? "border-start border-primary border-3" : "border-start border-warning border-3";

										<div class="list-group-item @borderClass mb-3 px-3 py-2">
											<div class="d-flex justify-content-between align-items-start mb-2">
												<h5 class="mb-1 font-monospace">@role.ToString()</h5>
												@if (role.IsApplicationRole) {
													<span class="badge bg-primary rounded-pill">
														<i class="bi bi-shield-lock me-1" />App Role
													</span>
												} else {
													<span class="badge bg-warning rounded-pill">
														<i class="bi bi-person-gear me-1" />Custom Role
													</span>
												}
											</div>

											<div class="role-metrics text-muted small mb-2">
												<span class="me-3">Depth: @roleInfo.CurrentOrder</span>
												<span class="me-3">Inherits: @roleInfo.InheritsFromCount</span>
												<span>Inherited by: @roleInfo.InheritedByCount</span>
											</div>

											@if (roleInfo.ChildRoles.Count > 0) {
												<div class="mb-1">
													<small class="text-muted"><strong>Inherits from:</strong></small>
													<div class="mt-1">
														@foreach (var childRole in roleInfo.ChildRoles) {
															<span class="badge bg-light text-dark border me-1 mb-1">@childRole.ToString()</span>
														}
													</div>
												</div>
											}

											@if (roleInfo.ParentRoles.Count > 0) {
												<div class="mb-1">
													<small class="text-muted"><strong>Inherited by:</strong></small>
													<div class="mt-1">
														@foreach (var parentRole in roleInfo.ParentRoles) {
															<span class="badge bg-light text-dark border me-1 mb-1">@parentRole.ToString()</span>
														}
													</div>
												</div>
											}
										</div>
									}
								</div>
							</div>
						</div>
					</div>
				</Tab>

				<Tab Name="Policies">
					<PolicyExecutionDiagram Theme="@CurrentTheme"
											ShowOnlyCurrentRuntime="true"
											MaxPoliciesInDiagram="50" />
				</Tab>

				<Tab Name="Security Analysis">
					@if (AnalysisReport != null) {
						<div class="mb-4">
							<h4>Analysis Summary</h4>
							<div class="row g-3">
								@foreach (var analyzer in AnalyzerSummaries.OrderByDescending(a => a.IssueCount)) {
									<div class="col-md-6 col-lg-4">
										<div class="card @(analyzer.IssueCount == 0 ? "border-success" : "border-warning")">
											<div class="card-body">
												<h6 class="card-title">@analyzer.Category</h6>
												<div class="d-flex justify-content-between">
													<span>Issues: @analyzer.IssueCount</span>
													<span class="@(analyzer.IssueCount == 0 ? "text-success" : "text-warning")">
														@(analyzer.IssueCount == 0 ? "Clean" : "Issues")
													</span>
												</div>
												@if (analyzer.IssueCount > 0) {
													<div class="mt-2 small">
														<span class="text-danger">E: @analyzer.ErrorCount</span>
														<span class="text-warning ms-2">W: @analyzer.WarningCount</span>
														<span class="text-info ms-2">I: @analyzer.InfoCount</span>
													</div>
												}
											</div>
										</div>
									</div>
								}
							</div>
						</div>

						<SecurityIssuesAccordion AnalysisReport="@AnalysisReport" />
					} else {
						<div class="alert alert-info">
							Run analysis to see security report...
						</div>
					}
				</Tab>

				<Tab Name="Raw Report">
					<div class="raw-report-section">
						<div class="btn-group mb-3" role="group">
							<button class="btn btn-outline-secondary @(ReportFormat == "markdown" ? "active" : "")"
									@onclick="@(() => ReportFormat = "markdown")">
								Markdown
							</button>
							<button class="btn btn-outline-secondary @(ReportFormat == "text" ? "active" : "")"
									@onclick="@(() => ReportFormat = "text")">
								Text
							</button>
							<button class="btn btn-outline-secondary @(ReportFormat == "json" ? "active" : "")"
									@onclick="@(() => ReportFormat = "json")">
								JSON
							</button>
						</div>

						<pre class="bg-light p-3 rounded" style="max-height: 600px; overflow: auto;">@GetFormattedReport()</pre>
					</div>
				</Tab>
			</Tabs>
		</ContentTemplate>
	</ContentLoader>
</div>

<style>
	.authorization-visualization .summary-cards .card {
		transition: transform 0.2s;
	}

	.authorization-visualization .summary-cards .card:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 8px rgba(0,0,0,0.1);
	}

	.authorization-visualization .metric-category {
		padding: 1rem;
		background: #f8f9fa;
		border-radius: 0.5rem;
	}

	.authorization-visualization .role-metrics {
		font-size: 0.875rem;
	}

	.authorization-visualization .analysis-options {
		border: 1px solid #dee2e6;
	}

	.authorization-visualization .raw-report-section pre {
		font-size: 0.875rem;
		line-height: 1.4;
	}
</style>

@code {
	// Configuration parameters
	[Parameter] public bool ShowExportButtons { get; set; } = true;
	[Parameter] public bool ShowAnalysisOptions { get; set; } = true;
	[Parameter] public string InitialTheme { get; set; } = "dark";
	[Parameter] public EventCallback<Exception> OnError { get; set; }

	// Analysis state
	protected AnalysisReport? AnalysisReport;
	protected AnalysisSummary? AnalysisSummary;
	protected DomainCatalog? ResourceCatalog;

	// Analysis options
	protected int MaxHierarchyDepth = 10;
	protected bool IncludeInfoIssues = true;

	// Grouped data
	protected IEnumerable<IGrouping<string, KeyValuePair<string, int>>>? MetricsByCategory;
	protected List<AnalyzerSummaryInfo> AnalyzerSummaries = new();

	// UI state
	protected string CurrentTheme = "dark";
	protected string RoleFilter = "";
	protected string _lastRoleFilter = "";
	protected string ReportFormat = "markdown";
	protected bool IsLoading = true;
	protected string LoadingMessage = "Initializing...";

	// Visualization data
	protected string RoleHierarchyDiagram = string.Empty;
	protected string AuthFlowDiagram = string.Empty;
	protected IImmutableSet<Role> AllRoles = ImmutableHashSet<Role>.Empty;
	protected int TotalRoles;

	// Cached role display info
	protected List<RoleDisplayInfo>? _cachedRoleDisplayInfos;
	protected List<RoleDisplayInfo>? _cachedFilteredRoles;

	protected record AnalyzerSummaryInfo(
		string Category,
		int IssueCount,
		int ErrorCount,
		int WarningCount,
		int InfoCount
	);

	protected override void OnInitialized() {
		CurrentTheme = InitialTheme;
	}

	protected override async Task OnAfterRenderAsync(bool firstRender) {
		if (firstRender) {
			await InitializeAsync();
		}
	}

	private async Task InitializeAsync() {
		try {
			LoadingMessage = "Initializing Mermaid service...";
			StateHasChanged();

			await MermaidService.InitializeAsync();

			await RefreshAllDataAsync(refreshDiagrams: true);
		} catch (Exception ex) {
			await OnError.InvokeAsync(ex);
		} finally {
			IsLoading = false;
			StateHasChanged();
		}
	}

	/// <summary>
	/// Consolidated refresh method that handles all data loading scenarios.
	/// </summary>
	/// <param name="refreshDiagrams">Whether to reload diagrams (expensive operation)</param>
	/// <param name="forceRefresh">Whether to call RefreshAsync on the data service first</param>
	protected async Task RefreshAllDataAsync(bool refreshDiagrams = false, bool forceRefresh = false) {
		try {
			if (forceRefresh) {
				LoadingMessage = "Refreshing authorization data...";
				StateHasChanged();
				await AuthorizationDataService.RefreshAsync(MaxHierarchyDepth);
			}

			if (refreshDiagrams) {
				LoadingMessage = "Loading diagrams...";
				StateHasChanged();

				RoleHierarchyDiagram = await AuthorizationDataService.GetRoleHierarchyDiagramAsync();
				AuthFlowDiagram = await AuthorizationDataService.GetAuthorizationFlowDiagramAsync();

				// Get roles and rebuild cache
				AllRoles = (await AuthorizationDataService.GetRolesAsync()).ToImmutableHashSet();
				TotalRoles = AllRoles.Count;
				InvalidateRoleCache();
			}

			LoadingMessage = "Running security analysis...";
			StateHasChanged();

			AnalysisReport = await AuthorizationDataService.GetAnalysisReportAsync(MaxHierarchyDepth);
			AnalysisSummary = await AuthorizationDataService.GetAnalysisSummaryAsync(MaxHierarchyDepth);
			ResourceCatalog = await AuthorizationDataService.GetCatalogAsync();

			ProcessAnalysisResults();

		} catch (Exception ex) {
			await OnError.InvokeAsync(ex);
		}
	}

	private void ProcessAnalysisResults() {
		if (AnalysisReport == null) return;

		// Filter issues based on IncludeInfoIssues setting
		var filteredIssues = IncludeInfoIssues
			? AnalysisReport.Issues
			: AnalysisReport.Issues.Where(i => i.Severity != IssueSeverity.Info).ToList();

		MetricsByCategory = AnalysisReport.Metrics
			.GroupBy(m => MetricCategories.GetMetricCategoryDisplayName(m.Key))
			.OrderBy(g => g.Key);

		var issuesByCategory = filteredIssues
			.GroupBy(i => i.Category)
			.ToDictionary(g => g.Key, g => g.ToList());

		AnalyzerSummaries = AnalysisReport.AnalyzerCategories
			.Select(cat => {
				var issues = issuesByCategory.GetValueOrDefault(cat, []);
				return new AnalyzerSummaryInfo(
					cat,
					issues.Count,
					issues.Count(i => i.Severity == IssueSeverity.Error),
					issues.Count(i => i.Severity == IssueSeverity.Warning),
					issues.Count(i => i.Severity == IssueSeverity.Info)
				);
			})
			.ToList();
	}

	protected async Task RefreshAnalysis() {
		IsLoading = true;
		try {
			await RefreshAllDataAsync(refreshDiagrams: true, forceRefresh: true);
		} finally {
			IsLoading = false;
			StateHasChanged();
		}
	}

	protected void ToggleTheme() {
		CurrentTheme = CurrentTheme == "dark" ? "default" : "dark";
	}

	protected async Task ApplyOptionsAndReanalyze() {
		IsLoading = true;
		try {
			await RefreshAllDataAsync(refreshDiagrams: false, forceRefresh: true);
		} finally {
			IsLoading = false;
			StateHasChanged();
		}
	}

	// Export functions
	protected async Task ExportMarkdown() {
		if (AnalysisReport == null) return;

		var markdown = await StaticDocumenter.GenerateMarkdown();
		await DownloadFile("authorization-documentation.md", markdown, "text/markdown");
	}

	protected async Task ExportHtml() {
		if (AnalysisReport == null) return;

		var html = await StaticDocumenter.RenderHtmlPage();
		await DownloadFile("authorization-documentation.html", html, "text/html");
	}

	protected async Task ExportCsv() {
		if (AnalysisReport == null) return;

		var csv = await StaticDocumenter.GenerateCsv();
		await DownloadFile("authorization-documentation.csv", csv, "text/csv");
	}

	protected async Task DownloadFile(string filename, string content, string contentType) {
		try {
			await FileSystem.DownloadFileAsync(System.Text.Encoding.UTF8.GetBytes(content), filename, contentType);
		} catch (Exception ex) {
			await OnError.InvokeAsync(ex);
		}
	}

	// Helper methods

	protected void InvalidateRoleCache() {
		_cachedRoleDisplayInfos = null;
		_cachedFilteredRoles = null;
		_lastRoleFilter = "";
	}

	private List<RoleDisplayInfo> GetAllRoleDisplayInfos() {
		if (_cachedRoleDisplayInfos != null) return _cachedRoleDisplayInfos;

		_cachedRoleDisplayInfos = AllRoles.Select(r => new RoleDisplayInfo {
			Role = r,
			RoleString = r.ToString(),
			ChildRoles = RoleRegistry.GetInheritedRoles(r).ToImmutableHashSet(),
			ParentRoles = RoleRegistry.GetInheritingRoles(r).ToImmutableHashSet(),
			InheritsFromCount = RoleRegistry.GetInheritedRoles(r).Count,
			InheritedByCount = RoleRegistry.GetInheritingRoles(r).Count,
			CurrentOrder = GetHierarchyDepth(r, RoleRegistry, new HashSet<Role>())
		})
		.OrderBy(x => x.CurrentOrder)
		.ThenBy(x => x.RoleString)
		.ToList();

		return _cachedRoleDisplayInfos;
	}

	protected IEnumerable<RoleDisplayInfo> GetFilteredRoles() {
		var allRoles = GetAllRoleDisplayInfos();

		// Return cached filtered results if filter hasn't changed
		if (_cachedFilteredRoles != null && _lastRoleFilter == RoleFilter) {
			return _cachedFilteredRoles;
		}

		_lastRoleFilter = RoleFilter;

		if (string.IsNullOrWhiteSpace(RoleFilter)) {
			_cachedFilteredRoles = allRoles;
		} else {
			_cachedFilteredRoles = allRoles
				.Where(r => r.RoleString.Contains(RoleFilter, StringComparison.OrdinalIgnoreCase))
				.ToList();
		}

		return _cachedFilteredRoles;
	}

	protected class RoleDisplayInfo {
		public Role Role { get; init; } = default!;
		public string RoleString { get; init; } = string.Empty;
		public IReadOnlySet<Role> ChildRoles { get; init; } = new HashSet<Role>();
		public IReadOnlySet<Role> ParentRoles { get; init; } = new HashSet<Role>();
		public int InheritsFromCount { get; init; }
		public int InheritedByCount { get; init; }
		public int CurrentOrder { get; init; }
	}

	protected static int GetHierarchyDepth(Role role, IAuthorizationRoleRegistry registry, HashSet<Role> visited) {
		if (visited.Contains(role))
			return 0;
		visited.Add(role);

		var inheritedRoles = registry.GetInheritedRoles(role);
		if (!inheritedRoles.Any())
			return 0;

		return inheritedRoles.Max(inherited => GetHierarchyDepth(inherited, registry, new HashSet<Role>(visited))) + 1;
	}

	protected string GetFormattedReport() {
		if (AnalysisReport == null) return "No analysis report available";

		return ReportFormat switch {
			"markdown" => AnalysisReport.ToMarkdown(),
			"text" => AnalysisReport.ToText(),
			"json" => System.Text.Json.JsonSerializer.Serialize(new {
				Summary = AnalysisSummary,
				Issues = AnalysisReport.Issues,
				Metrics = AnalysisReport.Metrics,
				Analyzers = AnalysisReport.AnalyzerCategories
			}, new System.Text.Json.JsonSerializerOptions { WriteIndented = true }),
			_ => "Unknown format"
		};
	}
}
